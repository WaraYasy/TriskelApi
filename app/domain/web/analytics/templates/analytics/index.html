{% extends "analytics/base_dashboard.html" %}

{% block title %}Analytics - Triskel Dashboard{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block extra_head %}
<style>
    /* Loader styles */
    .loader-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-primary, #10b981);
        animation: pulse 1.2s ease-in-out infinite;
    }
    .loader-dot::before, .loader-dot::after {
        content: '';
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-primary, #10b981);
        margin-left: 6px;
        animation: pulse 1.2s ease-in-out infinite;
    }
    .loader-dot::before { animation-delay: 0.2s; }
    .loader-dot::after { animation-delay: 0.4s; }

    @keyframes pulse {
        0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
        40% { opacity: 1; transform: scale(1); }
    }

    .chart-loader {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: var(--color-text-secondary, #9ca3af);
        gap: 1rem;
    }

    .loader-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--color-border, #374151);
        border-top-color: var(--color-primary, #10b981);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Top Bar -->
<header class="top-bar">
    <div class="top-bar-left">
        <h1 class="page-title">Analytics Dashboard</h1>
        <p class="page-subtitle">Métricas y visualizaciones del juego</p>
    </div>
</header>

<!-- Stats Grid -->
<section class="stats-section">
    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Jugadores</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-players"><span class="loader-dot"></span></div>
            <div class="stat-meta">Total registrados</div>
        </div>
    </div>

    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Partidas</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-games"><span class="loader-dot"></span></div>
            <div class="stat-meta">Total jugadas</div>
        </div>
    </div>

    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Tiempo Promedio</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-playtime"><span class="loader-dot"></span></div>
            <div class="stat-meta">Por partida</div>
        </div>
    </div>

    <div class="stat-card-admin highlight">
        <div class="stat-header">
            <span class="stat-title">Completado</span>
        </div>
        <div class="stat-body">
            <div class="stat-number-large" id="stat-completion"><span class="loader-dot"></span></div>
            <div class="stat-meta">Tasa de completado</div>
        </div>
    </div>
</section>

<!-- Segunda fila de stats -->
<section class="stats-section">
    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Muertes</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-deaths"><span class="loader-dot"></span></div>
            <div class="stat-meta">Total en el juego</div>
        </div>
    </div>

    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Eventos</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-events"><span class="loader-dot"></span></div>
            <div class="stat-meta">Registrados</div>
        </div>
    </div>

    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Muertes/Partida</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-avg-deaths"><span class="loader-dot"></span></div>
            <div class="stat-meta">Promedio</div>
        </div>
    </div>

    <div class="stat-card-admin">
        <div class="stat-header">
            <span class="stat-title">Completadas</span>
        </div>
        <div class="stat-body">
            <div class="stat-number" id="stat-completed"><span class="loader-dot"></span></div>
            <div class="stat-meta">Partidas terminadas</div>
        </div>
    </div>
</section>

<!-- Charts Section -->
<section class="charts-section">
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Jugadores Activos (Últimos 7 días)</h3>
        </div>
        <div class="chart-body" id="chart-active-players">
            <div class="chart-loader">
                <div class="loader-spinner"></div>
                <span>Cargando gráfico...</span>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Distribución de Decisiones Morales</h3>
        </div>
        <div class="chart-body" id="chart-moral">
            <div class="chart-loader">
                <div class="loader-spinner"></div>
                <span>Cargando gráfico...</span>
            </div>
        </div>
    </div>
</section>

<section class="charts-section">
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Alineación Moral de Jugadores</h3>
        </div>
        <div class="chart-body" id="chart-alignment">
            <div class="chart-loader">
                <div class="loader-spinner"></div>
                <span>Cargando gráfico...</span>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Muertes por Nivel</h3>
        </div>
        <div class="chart-body" id="chart-deaths">
            <div class="chart-loader">
                <div class="loader-spinner"></div>
                <span>Cargando gráfico...</span>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block footer_text %}Triskel Analytics Dashboard © 2026 - Mandrágora{% endblock %}

{% block extra_scripts %}
<script>
    // Esperar a que Plotly esté disponible antes de cargar gráficos
    function waitForPlotly(callback) {
        if (typeof Plotly !== 'undefined') {
            callback();
        } else {
            setTimeout(() => waitForPlotly(callback), 100);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadMetrics();
        waitForPlotly(loadCharts);
    });

    async function loadMetrics() {
        try {
            const response = await fetch('/web/dashboard/api/metrics');
            if (!response.ok) throw new Error('Error cargando métricas');

            const metrics = await response.json();

            animateStat('stat-players', metrics.total_players || 0);
            animateStat('stat-games', metrics.total_games || 0);
            document.getElementById('stat-playtime').textContent =
                ((metrics.avg_playtime || 0) / 3600).toFixed(1) + 'h';
            document.getElementById('stat-completion').textContent =
                (metrics.completion_rate || 0) + '%';
            animateStat('stat-deaths', metrics.total_deaths || 0);
            animateStat('stat-events', metrics.total_events || 0);
            document.getElementById('stat-avg-deaths').textContent =
                (metrics.avg_deaths || 0).toFixed(1);
            animateStat('stat-completed', metrics.completed_games || 0);

        } catch (error) {
            console.error('Error cargando métricas:', error);
            showMetricsError();
        }
    }

    async function loadCharts() {
        const chartPromises = [
            loadChart('chart-active-players', '/web/dashboard/api/charts/active-players'),
            loadChart('chart-moral', '/web/dashboard/api/charts/moral'),
            loadChart('chart-alignment', '/web/dashboard/api/charts/alignment'),
            loadChart('chart-deaths', '/web/dashboard/api/charts/deaths')
        ];

        await Promise.all(chartPromises);
    }

    async function loadChart(elementId, url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Error cargando gráfico');

            const data = await response.json();
            document.getElementById(elementId).innerHTML = data.html;

        } catch (error) {
            console.error(`Error cargando ${elementId}:`, error);
            document.getElementById(elementId).innerHTML =
                '<div class="chart-loader"><span>Error al cargar el gráfico</span></div>';
        }
    }

    function animateStat(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const duration = 800;
        const start = 0;
        const startTime = performance.now();

        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const current = Math.round(start + (targetValue - start) * easeOut);

            element.textContent = current.toLocaleString();

            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }

        requestAnimationFrame(update);
    }

    function showMetricsError() {
        const ids = ['stat-players', 'stat-games', 'stat-playtime', 'stat-completion',
                    'stat-deaths', 'stat-events', 'stat-avg-deaths', 'stat-completed'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '-';
        });
    }
</script>
{% endblock %}
