{% extends "analytics/base_dashboard.html" %}

{% block title %}Métricas Avanzadas - Triskel Dashboard{% endblock %}
{% block nav_advanced %}active{% endblock %}

{% block content %}
<header class="top-bar">
    <div class="top-bar-left">
        <h1 class="page-title">Métricas Avanzadas</h1>
        <p class="page-subtitle">Análisis detallado de gameplay y progresión</p>
    </div>
</header>

<section class="stats-section">
    <div class="stat-card-admin">
        <div class="stat-header"><span class="stat-title">Muertes Totales</span></div>
        <div class="stat-body">
            <div class="stat-number" id="stat-deaths"><span class="loader-dot"></span></div>
            <div class="stat-meta">En todas las partidas</div>
        </div>
    </div>
    <div class="stat-card-admin">
        <div class="stat-header"><span class="stat-title">Reliquias</span></div>
        <div class="stat-body">
            <div class="stat-number" id="stat-relics"><span class="loader-dot"></span></div>
            <div class="stat-meta">Reliquias obtenidas</div>
        </div>
    </div>
    <div class="stat-card-admin highlight">
        <div class="stat-header"><span class="stat-title">Completado</span></div>
        <div class="stat-body">
            <div class="stat-number-large" id="stat-completion"><span class="loader-dot"></span></div>
            <div class="stat-meta">Promedio de progreso</div>
        </div>
    </div>
    <div class="stat-card-admin">
        <div class="stat-header"><span class="stat-title">Partidas</span></div>
        <div class="stat-body">
            <div class="stat-number" id="stat-games"><span class="loader-dot"></span></div>
            <div class="stat-meta">Total analizadas</div>
        </div>
    </div>
</section>

<section class="charts-section">
    <div class="chart-card">
        <div class="chart-header"><h3 class="chart-title">Distribución de Reliquias</h3></div>
        <div class="chart-body" id="chart-relics">
            <div class="chart-loader"><div class="loader-spinner"></div><span>Cargando gráfico...</span></div>
        </div>
    </div>
    <div class="chart-card">
        <div class="chart-header"><h3 class="chart-title">Tasa de Completado por Nivel</h3></div>
        <div class="chart-body" id="chart-completion">
            <div class="chart-loader"><div class="loader-spinner"></div><span>Cargando gráfico...</span></div>
        </div>
    </div>
</section>

<section class="charts-section">
    <div class="chart-card large">
        <div class="chart-header"><h3 class="chart-title">Tiempo Promedio por Nivel</h3></div>
        <div class="chart-body" id="chart-playtime">
            <div class="chart-loader"><div class="loader-spinner"></div><span>Cargando gráfico...</span></div>
        </div>
    </div>
</section>

<section class="events-section">
    <div class="section-header"><h2 class="section-title">Partidas Recientes</h2></div>
    <div class="events-table">
        <table>
            <thead>
                <tr><th>GAME ID</th><th>JUGADOR</th><th>ESTADO</th><th>COMPLETADO</th><th>MUERTES</th><th>RELIQUIAS</th><th>INICIO</th></tr>
            </thead>
            <tbody id="games-table-body">
                <tr><td colspan="7" style="text-align: center; padding: 2rem;"><div class="loader-spinner" style="margin: 0 auto;"></div></td></tr>
            </tbody>
        </table>
    </div>
</section>
{% endblock %}

{% block footer_text %}Triskel Analytics - Métricas Avanzadas © 2026 - Mandrágora{% endblock %}

{% block extra_scripts %}
<script>
    // Esperar a que Plotly esté disponible antes de cargar gráficos
    function waitForPlotly(callback) {
        if (typeof Plotly !== 'undefined') {
            callback();
        } else {
            setTimeout(() => waitForPlotly(callback), 100);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadAdvancedMetrics();
        waitForPlotly(loadCharts);
    });

    async function loadAdvancedMetrics() {
        try {
            const response = await fetch('/web/dashboard/api/advanced');
            if (!response.ok) throw new Error('Error');
            const data = await response.json();

            document.getElementById('stat-deaths').textContent = data.total_deaths || 0;
            document.getElementById('stat-relics').textContent = data.total_relics || 0;
            document.getElementById('stat-completion').textContent = (data.avg_completion_percentage || 0) + '%';
            document.getElementById('stat-games').textContent = data.total_games || 0;

            const tbody = document.getElementById('games-table-body');
            const games = data.games || [];
            if (games.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;padding:2rem;">No hay partidas disponibles</td></tr>';
                return;
            }

            tbody.innerHTML = games.map(game => `
                <tr>
                    <td style="font-family:monospace;">${game.game_id.substring(0,8)}...</td>
                    <td>${game.player_id.substring(0,8)}...</td>
                    <td>${game.status === 'completed' ? '<span class="event-status completed">completado</span>' : game.status === 'in_progress' ? '<span class="event-status started">en progreso</span>' : `<span class="event-status event">${game.status}</span>`}</td>
                    <td>${(game.completion_percentage || 0).toFixed(1)}%</td>
                    <td>${game.metrics?.total_deaths || 0}</td>
                    <td>${game.relics && game.relics.length ? game.relics.join(', ') : '<span style="color:#6b7280;">-</span>'}</td>
                    <td style="color:#9ca3af;">${game.started_at || '-'}</td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
            ['stat-deaths', 'stat-relics', 'stat-completion', 'stat-games'].forEach(id => {
                document.getElementById(id).textContent = '-';
            });
            document.getElementById('games-table-body').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#ef4444;padding:2rem;">Error al cargar datos</td></tr>';
        }
    }

    async function loadCharts() {
        const charts = [
            { id: 'chart-relics', url: '/web/dashboard/api/charts/relics' },
            { id: 'chart-completion', url: '/web/dashboard/api/charts/completion' },
            { id: 'chart-playtime', url: '/web/dashboard/api/charts/playtime-level' }
        ];

        await Promise.all(charts.map(async chart => {
            const container = document.getElementById(chart.id);

            try {
                const response = await fetch(chart.url);
                if (!response.ok) throw new Error('Error cargando gráfico');

                const data = await response.json();

                // Ocultar loader
                const loader = container.querySelector('.chart-loader');
                if (loader) loader.style.display = 'none';

                // Renderizar con Plotly.newPlot
                if (data.html) {
                    const figData = JSON.parse(data.html);
                    Plotly.newPlot(
                        chart.id,
                        figData.data,
                        figData.layout,
                        {displayModeBar: false, responsive: true}
                    );
                } else {
                    throw new Error('No chart data received');
                }
            } catch (error) {
                console.error('Error cargando gráfico:', error);
                container.innerHTML = '<div class="chart-loader"><span>Error al cargar el gráfico</span></div>';
            }
        }));
    }
</script>
{% endblock %}
